function Event(name){this.name=name,this.callbacks=[]}function Reactor(){this.events={}}function vComic(){for(var playerStates={uninitialized:0,playing:1,paused:2,stoped:3},i=0;i<playerStates.length;i++){var code=playerStates[i];playerStates[code]=i}var player={dom:!1,state:{code:playerStates.uninitialized,name:playerStates[playerStates.uninitialized]},chapter:!1},chapters=[],timeEvents=[],listener=new Reactor;listener.registerEvent("chapterChange"),listener.registerEvent("playerStateChange"),listener.registerEvent("end"),this.setPlayer=function(playerDom){player.dom=playerDom,setPlayerEvents()},this.addChapter=function(chapterObj){var lastChapterFileUrl=chapters.length&&"undefined"!=typeof chapters[chapters.length]?chapters[chapters.length].fileUrl:!1;chapters.push({number:chapterObj.number,name:"undefined"!=typeof chapterObj.name?chapterObj.name:!1,time:"undefined"!=typeof chapterObj.time?chapterObj.time:0,fileUrl:"undefined"!=typeof chapterObj.fileUrl?chapterObj.fileUrl:lastChapterFileUrl})},this.addPause=function(pauseObj){timeEvents.push({type:"pause",fileUrl:pauseObj.fileUrl,time:pauseObj.time,handler:function(){pause()}})},this.start=function(){init()},this.on=function(event,callback){switch(event){case"chapterchange":case"chapterChange":listener.addEventListener("chapterChange",function(){callback(chapters.current())});break;case"playerstatechange":case"playerStateChange":listener.addEventListener("playerStateChange",function(){callback(player.state)});break;case"end":listener.addEventListener("end",function(){callback()})}},this.seekChapter=function(chapNumber){for(var iChapter=!1,chapsLength=chapters.length,i=0;chapsLength>i;i++){var auxChapter=chapters[i];if(auxChapter.number==chapNumber){iChapter=i;break}}iChapter!==!1&&nextChapter(iChapter,!0)};var init=function(){nextChapter()},nextChapter=function(chapIndex,bSeek){var chapter;if("undefined"!=typeof chapIndex){if(chapters.index==chapIndex)return!1;chapters.index=chapIndex,chapter=chapters.current()}else chapter=chapters.next();chapter?(~player.dom.src.indexOf(chapter.fileUrl)||(setPlayerSrc(chapter.fileUrl),initializeTimeEvents(),bSeek=!0),bSeek&&playerSeek(chapter.time),listener.dispatchEvent("chapterChange")):endOfContent()},setPlayerSrc=function(src){player.dom.src=src},playerSeek=function(time){player.dom.currentTime=time,play()},initializeTimeEvents=function(){var currentChapter=chapters.current();if(!currentChapter)return!1;for(var timeEventsLength=timeEvents.length,i=0;timeEventsLength>i;i++){var timeEvent=timeEvents[i];timeEvent.fileUrl==currentChapter.fileUrl&&player.dom.currentTime<timeEvent.time&&jQuery(player.dom).on("timeupdate",timeUpdateEvent(timeEvent.handler,timeEvent.time))}for(var chaptersLength=chapters.length,i=0;chaptersLength>i;i++){var chapter=chapters[i];chapter.fileUrl==currentChapter.fileUrl&&jQuery(player.dom).on("timeupdate",timeUpdateEvent(timeUpdateChapterEvent,{time:chapter.time,chapIndex:i}))}},timeUpdateEvent=function(handler,args){var wrapped=function(){var time="number"==typeof args?args:args.time;return this.currentTime>=time?(jQuery(this).off("timeupdate",wrapped),handler(args)):void 0};return wrapped},timeUpdateChapterEvent=function(args){nextChapter(args.chapIndex)},endOfContent=function(){listener.dispatchEvent("end")},setPlayerEvents=function(){player.dom.onplay=function(){setPlayerState(playerStates.playing)},player.dom.onpause=function(){setPlayerState(playerStates.paused)},player.dom.onended=function(){nextChapter()},player.dom.onseeking=function(){jQuery(player.dom).off("timeupdate")},player.dom.onseeked=function(){initializeTimeEvents()}},play=function(){player.dom.play()},pause=function(){player.dom.pause()},setPlayerState=function(code){player.state.code=code,player.state.name=playerStates[code],listener.dispatchEvent("playerStateChange")}}Array.prototype.next=function(){return this.index+1 in this?this[++this.index]:!1},Array.prototype.prev=function(){return this.index-1 in this?this[--this.index]:!1},Array.prototype.current=function(){return this.index in this?this[this.index]:!1},Array.prototype.index=-1,Event.prototype.registerCallback=function(callback){this.callbacks.push(callback)},Reactor.prototype.registerEvent=function(eventName){var event=new Event(eventName);this.events[eventName]=event},Reactor.prototype.dispatchEvent=function(eventName,eventArgs){return"undefined"==typeof this.events[eventName]?!1:void this.events[eventName].callbacks.forEach(function(callback){callback(eventArgs)})},Reactor.prototype.addEventListener=function(eventName,callback){this.events[eventName].registerCallback(callback)};var vComic=new vComic;